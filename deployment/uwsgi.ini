[uwsgi]
# uWSGI 配置文件用于运行 FastAPI 后端
# 路径: /home/ai-tracks-shopping-react/htdocs/shopping-react.ai-tracks.com/backend

# 重要：解决 _contextvars 错误
# 问题：uv 管理的 Python 可能缺少 C 扩展模块
# 解决方案：使用系统 Python 3.12 或明确指定 Python 解释器

# 方式 1: 使用系统 Python 3.12（推荐）
# 首先检查系统是否有 Python 3.12: which python3.12
# 如果有，使用系统 Python 创建虚拟环境：
#   python3.12 -m venv .venv
# 然后使用：
virtualenv = /home/ai-tracks-shopping-react/htdocs/shopping-react.ai-tracks.com/backend/.venv

# 方式 2: 明确指定 Python 解释器路径（如果虚拟环境使用系统 Python）
# 检查虚拟环境中的 Python: ls -la .venv/bin/python*
# 如果 .venv/bin/python 是系统 Python 的符号链接，使用：
# pythonpath = /home/ai-tracks-shopping-react/htdocs/shopping-react.ai-tracks.com/backend/.venv/bin

# 方式 3: 如果必须使用 uv 管理的 Python，需要重新编译 Python 或使用 gunicorn
# 推荐使用 gunicorn + uvicorn（见 deployment/README.md）

# Python 插件
plugins = python3
# 如果系统有多个 Python 版本，明确指定插件：
# plugins = python312
# 或者指定插件路径：
# plugins-dir = /usr/lib/uwsgi/plugins

master = true

# 监听 HTTP socket (匹配 Nginx proxy_pass)
http-socket = 127.0.0.1:8096

# FastAPI 应用入口
wsgi-file = /home/ai-tracks-shopping-react/htdocs/shopping-react.ai-tracks.com/backend/wsgi.py
callable = application

# 工作目录
chdir = /home/ai-tracks-shopping-react/htdocs/shopping-react.ai-tracks.com/backend

# 进程和线程配置
processes = 8
threads = 2
enable-threads = true

# 缓冲区大小
buffer-size = 65535

# 内存和请求限制
reload-on-rss = 512
max-requests = 1000
max-requests-delta = 500
harakiri = 60

# 权限设置
umask = 0022
uid = ai-tracks-shopping-react
gid = ai-tracks-shopping-react

# 进程管理
die-on-term = true
vacuum = true

# Cheaper mode (动态进程管理)
cheaper = 2
cheaper-initial = 2
cheaper-step = 2
cheaper-algo = spare

# 日志
logto = /var/log/uwsgi/shopping-react-backend.log
log-maxsize = 50000000
log-backupcount = 5

# 自动重载（开发时使用，生产环境可注释）
# py-autoreload = 1

# 环境变量（如果需要）
# env = ENVIRONMENT=production
# env = DATABASE_URL=...

# 如果需要使用 ASGI，可以安装 uwsgi-asgi 插件
# 但 FastAPI 也可以通过 WSGI 模式运行（使用 asgiref 的 WSGIToASGIAdapter）
# 或者使用 gunicorn + uvicorn workers

